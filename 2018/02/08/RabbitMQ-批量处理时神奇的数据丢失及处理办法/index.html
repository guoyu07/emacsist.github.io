<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>RabbitMQ 批量处理时神奇的数据丢失及处理办法 | emacsist</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="rabbitmq,batch," />
  

  <meta name="description" content="起因线上DSP系统, 使用 RabbitMQ 作为竞价日志的中转站, 然后出队插入到MySQL. 于是就需要进行批量出队插入DB, 这样子性能和效率更高点. 但 RabbitMQ 自身, 并不支持一次性批量获取消息的. 只能通过以下设置来间接实现  设置 prefetch 然后不断获取消息 然后在确认的时候, basic.ack(消息ID, true) (这表示确认所有 &amp;lt;= 消息ID 的消">
<meta name="keywords" content="rabbitmq,batch">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ 批量处理时神奇的数据丢失及处理办法">
<meta property="og:url" content="https://emacsist.github.io/2018/02/08/RabbitMQ-批量处理时神奇的数据丢失及处理办法/index.html">
<meta property="og:site_name" content="emacsist">
<meta property="og:description" content="起因线上DSP系统, 使用 RabbitMQ 作为竞价日志的中转站, 然后出队插入到MySQL. 于是就需要进行批量出队插入DB, 这样子性能和效率更高点. 但 RabbitMQ 自身, 并不支持一次性批量获取消息的. 只能通过以下设置来间接实现  设置 prefetch 然后不断获取消息 然后在确认的时候, basic.ack(消息ID, true) (这表示确认所有 &amp;lt;= 消息ID 的消">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://emacsist.github.io/img/rabbit-channel-0.png">
<meta property="og:image" content="https://emacsist.github.io/img/rabbit-channel-1.png">
<meta property="og:image" content="https://emacsist.github.io/img/rabbit-channel-2.png">
<meta property="og:image" content="https://emacsist.github.io/img/rabbit-channel-3.png">
<meta property="og:updated_time" content="2018-02-08T04:39:51.136Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="RabbitMQ 批量处理时神奇的数据丢失及处理办法">
<meta name="twitter:description" content="起因线上DSP系统, 使用 RabbitMQ 作为竞价日志的中转站, 然后出队插入到MySQL. 于是就需要进行批量出队插入DB, 这样子性能和效率更高点. 但 RabbitMQ 自身, 并不支持一次性批量获取消息的. 只能通过以下设置来间接实现  设置 prefetch 然后不断获取消息 然后在确认的时候, basic.ack(消息ID, true) (这表示确认所有 &amp;lt;= 消息ID 的消">
<meta name="twitter:image" content="https://emacsist.github.io/img/rabbit-channel-0.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbe6" rel="stylesheet">


  
    <link rel="stylesheet" href="/css/personal-style.css">
  

  

  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b870e52c6cd914cb42627e4a706700b7";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  

  
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header LEFT">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tags/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/books/"
            rel="noopener noreferrer"
            target="_self"
            >
            阅读
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#起因"><span class="toc-text">起因</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#代码"><span class="toc-text">代码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#版本一"><span class="toc-text">版本一</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题"><span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#版本2"><span class="toc-text">版本2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#代码问题"><span class="toc-text">代码问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决"><span class="toc-text">解决</span></a></li></ol></li></ol></li></ol>
  </div>



<div class="content content-post LEFT">
   <article id="post-RabbitMQ-批量处理时神奇的数据丢失及处理办法" class="article article-type-post" itemprop="blogPost">
    <header class="article-header">
        <h1 class="post-title">
            RabbitMQ 批量处理时神奇的数据丢失及处理办法
        </h1>

        <div class="article-meta">
            <span>
        <i class="icon-calendar"></i>
        <span>2018.02.08</span>
            </span>

            
                <span class="article-author">
          <i class="icon-user"></i>
          <span>emacsist</span>
                </span>
                

                    
    <span class="article-category">
    <i class="icon-list"></i>
    
      <a class="tag-item" href="/tags/#batch">
        <span class="tag-name">batch</span>
    <span class="tag-size">( 2 )</span>
    </a>
    
      <a class="tag-item" href="/tags/#rabbitmq">
        <span class="tag-name">rabbitmq</span>
    <span class="tag-size">( 21 )</span>
    </a>
    

        </span>
        

                        

                                

                                        

        </div>
    </header>

    <div class="article-content">
        
                            <h1 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h1><p>线上DSP系统, 使用 RabbitMQ 作为竞价日志的中转站, 然后出队插入到MySQL. 于是就需要进行批量出队插入DB, 这样子性能和效率更高点.</p>
<p>但 RabbitMQ 自身, 并不支持一次性批量获取消息的. 只能通过以下设置来间接实现</p>
<ul>
<li>设置 prefetch</li>
<li>然后不断获取消息</li>
<li>然后在确认的时候, <code>basic.ack(消息ID, true)</code> (这表示确认所有 <code>&lt;=</code> 消息ID 的消息)</li>
</ul>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><h2 id="版本一"><a href="#版本一" class="headerlink" title="版本一"></a>版本一</h2><p>一开始时, 有个同事是使用比较原始的 rabbitmq 的官方库, 手动来管理 RabbitMQ 的 <code>connection</code> 和 <code>channel</code> . 代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</div><div class="line"><span class="keyword">import</span> javax.annotation.PreDestroy;</div><div class="line"><span class="keyword">import</span> javax.annotation.Resource;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.AlreadyClosedException;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.ShutdownListener;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.ShutdownSignalException;</div><div class="line"><span class="keyword">import</span> com.company.util.Loggers;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitmqClient</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Resource</span> (name = <span class="string">"rabbitConnectionFactory"</span>)</div><div class="line">    <span class="keyword">private</span> ConnectionFactory rabbitConnectionFactory;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Connection rabbitConnection;</div><div class="line"></div><div class="line">    <span class="meta">@PostConstruct</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            rabbitConnection = rabbitConnectionFactory.newConnection();</div><div class="line">            rabbitConnection.addShutdownListener(<span class="keyword">new</span> ShutdownListener() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdownCompleted</span><span class="params">(ShutdownSignalException cause)</span> </span>&#123;</div><div class="line">                    Loggers.ERROR_LOG.error(<span class="string">"rabbitmq connection shutdown. reason: &#123;&#125;"</span>, cause);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@PreDestroy</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (rabbitConnection != <span class="keyword">null</span> &amp;&amp; rabbitConnection.isOpen()) &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                rabbitConnection.close();</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Channel <span class="title">getRabbitChannel</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">        	<span class="keyword">if</span> (!rabbitConnection.isOpen()) &#123;</div><div class="line">                <span class="keyword">synchronized</span> (rabbitConnection) &#123;</div><div class="line">                    <span class="keyword">if</span> (!rabbitConnection.isOpen()) &#123;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            Loggers.RUNNING_LOG.error(<span class="string">"rabbitmq connection try new connection. "</span>);</div><div class="line">                            rabbitConnection = rabbitConnectionFactory.newConnection();</div><div class="line">                            rabbitConnection.addShutdownListener(<span class="keyword">new</span> ShutdownListener() &#123;</div><div class="line">                                <span class="meta">@Override</span></div><div class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shutdownCompleted</span><span class="params">(ShutdownSignalException cause)</span> </span>&#123;</div><div class="line">                                    Loggers.ERROR_LOG.error(<span class="string">"rabbitmq connection shutdown. reason: &#123;&#125;"</span>, cause);</div><div class="line">                                &#125;</div><div class="line">                            &#125;);</div><div class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</div><div class="line">                            e.printStackTrace();</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        	</div><div class="line">            <span class="keyword">return</span> rabbitConnection.createChannel();</div><div class="line">        &#125; <span class="keyword">catch</span> (AlreadyClosedException ace) &#123;</div><div class="line">            Loggers.ERROR_LOG.error(<span class="string">"rabbitmq connection already close. error: &#123;&#125;"</span>, ace);</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后在其他地方出队时, 手动 close channel.</p>
<p>出队的处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.company.listener.bid;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.AMQP;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</div><div class="line"><span class="keyword">import</span> com.rabbitmq.client.QueueingConsumer;</div><div class="line"><span class="keyword">import</span> com.company.listener.RabbitmqClient;</div><div class="line"><span class="keyword">import</span> com.company.pojo.WinPriceLog;</div><div class="line"><span class="keyword">import</span> com.company.service.TaskBidLogService;</div><div class="line"><span class="keyword">import</span> com.company.service.rabbitmq.RabbitMQService;</div><div class="line"><span class="keyword">import</span> com.company.util.JsonUtil;</div><div class="line"><span class="keyword">import</span> com.company.util.Loggers;</div><div class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</div><div class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</div><div class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</div><div class="line"><span class="keyword">import</span> java.util.ArrayList;</div><div class="line"><span class="keyword">import</span> java.util.List;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.TimeoutException;</div><div class="line"></div><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WinPriceLogListener</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;log.dequeue.prefetch&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String prefetchCount;</div><div class="line"></div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;queue.win.price.log&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String winPriceLogQueue;</div><div class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;queue.win.price.log.process&#125;"</span>)</div><div class="line">    <span class="keyword">private</span> String winPriceLogQueProcess;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RabbitMQService queueService;</div><div class="line"></div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> TaskBidLogService taskBidLogService;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    <span class="keyword">private</span> RabbitmqClient rabbitmqClient;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">winPriceLogOutQueue</span><span class="params">(<span class="keyword">byte</span>[] msg)</span> </span>&#123;</div><div class="line">        winPriceLogOutQueue(<span class="keyword">new</span> String(msg, StandardCharsets.UTF_8));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">winPriceLogOutQueue</span><span class="params">(String _msg)</span> </span>&#123;</div><div class="line">        <span class="keyword">long</span> s = System.currentTimeMillis();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (StringUtils.isBlank(_msg)) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">long</span> enQueueTime = Long.parseLong(_msg);</div><div class="line">        Channel channel = rabbitmqClient.getRabbitChannel();</div><div class="line">        <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            AMQP.Queue.DeclareOk declareOk = channel.queueDeclare(winPriceLogQueue, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">int</span> messageCount = declareOk.getMessageCount();</div><div class="line">            <span class="keyword">if</span> (messageCount == <span class="number">0</span>) &#123; <span class="comment">//over if there's no message in queue</span></div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            channel.basicQos(Integer.parseInt(prefetchCount));</div><div class="line">            QueueingConsumer consumer = <span class="keyword">new</span> QueueingConsumer(channel);</div><div class="line">            channel.basicConsume(winPriceLogQueue, <span class="keyword">false</span>, consumer);</div><div class="line"></div><div class="line">            List&lt;WinPriceLog&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">            List&lt;QueueingConsumer.Delivery&gt; deliveryList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">            <span class="keyword">long</span> _s = System.currentTimeMillis();</div><div class="line">            <span class="keyword">while</span> (messageCount &gt; <span class="number">0</span>) &#123;</div><div class="line">                QueueingConsumer.Delivery delivery = consumer.nextDelivery(<span class="number">500</span>);</div><div class="line">                <span class="keyword">if</span> (delivery == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                String msg = <span class="keyword">new</span> String(delivery.getBody());</div><div class="line">                <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                WinPriceLog wpl = JsonUtil.jsonStr2Obj(msg, WinPriceLog.class);</div><div class="line">                list.add(wpl);</div><div class="line">                deliveryList.add(delivery);</div><div class="line"></div><div class="line">                messageCount--;</div><div class="line"></div><div class="line">                <span class="keyword">if</span> (deliveryList.size() % <span class="number">2500</span> == <span class="number">0</span>) &#123;</div><div class="line">                    <span class="keyword">int</span> affectedRow = taskBidLogService.insertWinPriceBatchJDBC(list);</div><div class="line">                    channel.basicAck(deliveryList.get(deliveryList.size() - <span class="number">1</span>).getEnvelope().getDeliveryTag(), <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                    Loggers.AUDIT_LOG.info(<span class="string">"&#123;&#125; winPriceLog out queue. consume using &#123;&#125;ms, insert:&#123;&#125; "</span>, <span class="keyword">new</span> Object[]&#123;deliveryList.size(), (System.currentTimeMillis()</div><div class="line">                            - _s), affectedRow&#125;);</div><div class="line">                    list.clear();</div><div class="line">                    deliveryList.clear();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">long</span> consumeCost = System.currentTimeMillis() - _s;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> effectRow = taskBidLogService.insertWinPriceBatchJDBC(list);</div><div class="line">            <span class="comment">//ack</span></div><div class="line">            <span class="keyword">if</span> (!CollectionUtils.isEmpty(deliveryList)) &#123;</div><div class="line">                channel.basicAck(deliveryList.get(deliveryList.size() - <span class="number">1</span>).getEnvelope().getDeliveryTag(), <span class="keyword">true</span>);</div><div class="line">            &#125;</div><div class="line">            Loggers.AUDIT_LOG.info(<span class="string">"&#123;&#125; winPriceLogs out queue.  totally using &#123;&#125;ms, consume using &#123;&#125;ms, effectRow: &#123;&#125;"</span>,</div><div class="line">                    <span class="keyword">new</span> Object[]&#123;deliveryList.size(), (System.currentTimeMillis() - s), consumeCost, effectRow&#125;);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (declareOk.getMessageCount() &gt; Integer.parseInt(prefetchCount)) &#123;<span class="comment">//message count of queue greater than [PREFETCH_COUNT]</span></div><div class="line">                queueService.putMessage(winPriceLogQueProcess, _msg);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            Loggers.ERROR_LOG.error(<span class="string">"win price log dequeue Exception. "</span>, e);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (channel != <span class="keyword">null</span> &amp;&amp; channel.isOpen()) &#123;</div><div class="line">                    channel.close();</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                Loggers.ERROR_LOG.error(<span class="string">"rabbitmq channel close IOException. &#123;&#125;"</span>, e);</div><div class="line">            &#125; <span class="keyword">catch</span> (TimeoutException e) &#123;</div><div class="line">                Loggers.ERROR_LOG.error(<span class="string">"rabbitmq channel close TimeoutException. &#123;&#125;"</span>, e);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><ul>
<li><p>可以看到  <code>getRabbitChannel()</code> 方法, 虽然使用了 double check 来判断 connection 的状态, 然后重连. 但是, 它没有限制资源以及连接的频率等, 导致线上 RabbitMQ 中间件出现阻塞等问题时, 这个方法会在短时间内, 连接大量的 Connection , 最后导致触发了 Linux 的 OOM 机制.</p>
</li>
<li><p>不知道是不是因为手动管理不当的原因, 当在高并发, 高出价率时, 经常会报 <code>com.rabbitmq.client.impl.UnknownChannelException: Unknown channel number X</code> 等异常</p>
</li>
</ul>
<p>几乎每次大量投放业务时, 这种现象经常会出现.</p>
<p>虽然正常情况下, 并没有数据丢失这种问题.</p>
<h2 id="版本2"><a href="#版本2" class="headerlink" title="版本2"></a>版本2</h2><p>既然项目中使用了 Spring 的 amqp 项目, 那为什么不用Spring RabbitTemplate 这些模板类来处理呢? Spring 有比较多的模板模式(比如  RedisTemplate, RabbitTemplte, RestTemplate等) 都是非常好用的. 它会自动管理资源和缓存等问题.</p>
<p>所以, 以下是使用 RabbitTemplate 后的代码版本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">winPriceLogOutQueue</span><span class="params">(<span class="keyword">final</span> String msg)</span> </span>&#123;</div><div class="line">     <span class="keyword">if</span> (StringUtils.isBlank(msg)) &#123;</div><div class="line">         <span class="keyword">return</span>;</div><div class="line">     &#125;</div><div class="line">     <span class="keyword">final</span> <span class="keyword">long</span> s = System.currentTimeMillis();</div><div class="line"></div><div class="line">     rabbitTemplate.execute(<span class="keyword">new</span> ChannelCallback&lt;Object&gt;() &#123;</div><div class="line">         <span class="meta">@Override</span></div><div class="line">         <span class="function"><span class="keyword">public</span> Object <span class="title">doInRabbit</span><span class="params">(<span class="keyword">final</span> Channel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">             DeclareOk declareOk = channel.queueDeclare(winPriceLogQueue, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">             <span class="keyword">int</span> messageCount = declareOk.getMessageCount();</div><div class="line">             <span class="keyword">if</span> (messageCount == <span class="number">0</span>) &#123; <span class="comment">//over if there's no message in queue</span></div><div class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">             &#125;</div><div class="line">             channel.basicQos(reloadableProperties.getPrefetchCount());</div><div class="line">             QueueingConsumer consumer = <span class="keyword">new</span> QueueingConsumer(channel);</div><div class="line">             channel.basicConsume(winPriceLogQueue, <span class="keyword">false</span>, <span class="string">"win price log out queue consumer"</span> + DateUtil.formartFullDate(<span class="keyword">new</span> Date()), consumer);</div><div class="line"></div><div class="line">             List&lt;WinPriceLog&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">             List&lt;Delivery&gt; deliveryList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">             <span class="keyword">long</span> messageId = -<span class="number">1</span>;</div><div class="line">             <span class="keyword">long</span> startTime = System.currentTimeMillis();</div><div class="line">             Loggers.WIN_LOG.info(<span class="string">"win price log dequeue size &#123;&#125;"</span>, messageCount);</div><div class="line">             <span class="keyword">int</span> totalEffectedRows = <span class="number">0</span>;</div><div class="line">             <span class="keyword">while</span> (messageCount-- &gt; <span class="number">0</span>) &#123;</div><div class="line">                 Delivery delivery = consumer.nextDelivery(<span class="number">500</span>);</div><div class="line">                 <span class="keyword">if</span> (delivery == <span class="keyword">null</span>) &#123;</div><div class="line">                     <span class="keyword">break</span>;</div><div class="line">                 &#125;</div><div class="line">                 messageId = delivery.getEnvelope().getDeliveryTag();</div><div class="line">                 String body = <span class="keyword">new</span> String(delivery.getBody());</div><div class="line">                 Loggers.WIN_LOG.info(<span class="string">"win price log dequeue &#123;&#125;"</span>, body);</div><div class="line">                 <span class="keyword">if</span> (StringUtils.isBlank(body)) &#123;</div><div class="line">                          <span class="keyword">continue</span>;</div><div class="line">                 &#125;</div><div class="line">                 WinPriceLog wpl = JsonUtil.jsonStr2Obj(body, WinPriceLog.class);</div><div class="line">                 list.add(wpl);</div><div class="line">                 deliveryList.add(delivery);</div><div class="line"></div><div class="line">                 <span class="keyword">if</span> (deliveryList.size() % <span class="number">2500</span> == <span class="number">0</span>) &#123;</div><div class="line">                     <span class="keyword">int</span> affectedRow = taskBidLogService.insertWinPriceBatchJDBC(list);</div><div class="line">                     totalEffectedRows += affectedRow;</div><div class="line">                     channel.basicAck(messageId, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">                     Loggers.AUDIT_LOG.info(<span class="string">"&#123;&#125; winPriceLog out queue. consume using &#123;&#125;ms, insert:&#123;&#125; "</span>, deliveryList.size(), System.currentTimeMillis()</div><div class="line">                             - startTime, affectedRow);</div><div class="line">                     list.clear();</div><div class="line">                     deliveryList.clear();</div><div class="line">                     messageId = -<span class="number">1</span>;</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">             <span class="keyword">long</span> consumeCost = System.currentTimeMillis() - startTime;</div><div class="line"></div><div class="line">             <span class="keyword">int</span> effectRow = taskBidLogService.insertWinPriceBatchJDBC(list);</div><div class="line">             totalEffectedRows += effectRow;</div><div class="line">             Loggers.WIN_LOG.info(<span class="string">"win price log dequeue insert db size &#123;&#125;"</span>, totalEffectedRows);</div><div class="line">             <span class="comment">//ack</span></div><div class="line">             <span class="keyword">if</span> (messageId &gt; <span class="number">0</span>) &#123;</div><div class="line">                 channel.basicAck(messageId, <span class="keyword">true</span>);</div><div class="line">             &#125;</div><div class="line">             Loggers.AUDIT_LOG.info(<span class="string">"&#123;&#125; winPriceLogs out queue.  totally using &#123;&#125;ms, consume using &#123;&#125;ms, effectRow: &#123;&#125;"</span>,</div><div class="line">                     deliveryList.size(), (System.currentTimeMillis() - s), consumeCost, effectRow);</div><div class="line"></div><div class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">         &#125;</div><div class="line">     &#125;);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>好处</p>
<ul>
<li>MQ 相关的资源 Connection , Channel 等, 全交给 Spring RabbitTemplate 来管理了. 避免手动管理不当而导致 OOM .</li>
</ul>
<h3 id="代码问题"><a href="#代码问题" class="headerlink" title="代码问题"></a>代码问题</h3><p>但是, 经过测试, 发现它会有 <code>数据丢失</code> 的问题!. RabbitMQ 一向是以稳定可靠, 以及保证数据不会丢失而著名的. 而我们在测试过程中, 竟然发现每次都会有数据丢失!</p>
<p>经过Debug, 发现导致的原因如下</p>
<ul>
<li>设置了 prefetch (相当于在 consumer 里设置了一个消息缓存池, RabbitMQ Server 会不断一条一条地发送消息过来, 直到达到 prefetch 大小为止, 不断这样子循环)</li>
<li>批量处理完后(参见以上代码) 虽然代码是处理了当时快照时的队列大小的消息: <code>DeclareOk declareOk = channel.queueDeclare(winPriceLogQueue, true, false, false, null); int messageCount = declareOk.getMessageCount();</code> 但是, 生产者还是会不断发送消息过来, 然后 MQ 还是会不断发送消息到 consumer</li>
<li>虽然我们 ack 了已经正确插入DB 的数据. 但是该 Channel 中, 它的 messageID ( messageID 在每个 channel 中是独立的, 即每一个 channel 中, 都有一个 messageID 计数器, 并且是从1开始不断递增的) 还是在不断地递增.</li>
<li>假设, 第一轮时, 我们处理了 100 消息( messageId 1~100), 但该 channel 中的 messageID 已经累计到 250 了(因为它还会不断接收 MQ Server 发送过来的消息, 只是我们还没有确认)</li>
<li>现在开始第二轮(由于 Spring amqp 默认情况下, 会缓存 channel 的), 它可能复用了第一轮的 Channel , 这时出队时的 messageID 是 251 了! 最后, 我们处理该轮消息时, 假设又处理了 100条, 即 (messageID为 351). 这时, 批量确认所有 messageID &lt;= 351 的消息, 就会导致中间的 (101~250) 这些消息, 没有被处理!但却被我们确认了!</li>
</ul>
<p>重现代码:</p>
<p>写一个不断发送消息的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">500000</span>; i++) &#123;</div><div class="line">            rabbitTemplate.convertAndSend(queueName, <span class="string">"hello"</span> + i);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        System.out.println(<span class="string">"done =======&gt; 1000"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;).start();</div></pre></td></tr></table></figure>
<p>还有一个批量出队的代码(模拟每次处理 100 条消息)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Scheduled</span>(cron = <span class="string">"*/5 * *  * * *"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">consumer</span><span class="params">()</span> </span>&#123;</div><div class="line">    rabbitTemplate.execute(channel -&gt; &#123;</div><div class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">final</span> AMQP.Queue.DeclareOk ok = channel.queueDeclare(queueName, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</div><div class="line">            <span class="keyword">int</span> messageCount = ok.getMessageCount();</div><div class="line">            log.info(<span class="string">"run consumer &#123;&#125;, msg count &#123;&#125;"</span>, sdf.format(<span class="keyword">new</span> Date()), messageCount);</div><div class="line">            <span class="keyword">if</span> (messageCount == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            channel.basicQos(<span class="number">100</span>);</div><div class="line">            QueueingConsumer queueingConsumer = <span class="keyword">new</span> QueueingConsumer(channel);</div><div class="line"></div><div class="line">            log.info(<span class="string">"channel id &#123;&#125;"</span>, Integer.toHexString(System.identityHashCode(channel)));</div><div class="line">            <span class="keyword">final</span> String inConsumerTag = <span class="string">"test consumer"</span> + sdf.format(<span class="keyword">new</span> Date());</div><div class="line">            channel.basicConsume(queueName, <span class="keyword">false</span>, inConsumerTag, queueingConsumer);</div><div class="line"></div><div class="line">            <span class="keyword">long</span> messageId = -<span class="number">1</span>;</div><div class="line">            <span class="keyword">int</span> dealedCount = <span class="number">0</span>;</div><div class="line">            <span class="keyword">int</span> i = <span class="number">100</span>;</div><div class="line">            <span class="keyword">while</span> (i-- &gt; <span class="number">0</span>) &#123;</div><div class="line">                QueueingConsumer.Delivery delivery = queueingConsumer.nextDelivery(<span class="number">100</span>);</div><div class="line">                <span class="keyword">if</span> (delivery == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                String msg = <span class="keyword">new</span> String(delivery.getBody());</div><div class="line"></div><div class="line">                messageId = delivery.getEnvelope().getDeliveryTag();</div><div class="line">                log.info(<span class="string">"get message &#123;&#125; delivery id &#123;&#125;"</span>, msg, messageId);</div><div class="line">                dealedCount++;</div><div class="line">                <span class="keyword">if</span> (dealedCount % <span class="number">5</span> == <span class="number">0</span>) &#123;</div><div class="line">                    channel.basicAck(messageId, <span class="keyword">true</span>);</div><div class="line">                    log.info(<span class="string">"batch ack message id =&gt;&#123;&#125;"</span>, messageId);</div><div class="line">                    messageId = -<span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (messageId &gt; <span class="number">0</span>) &#123;</div><div class="line">                channel.basicAck(messageId, <span class="keyword">true</span>);</div><div class="line">                log.info(<span class="string">"last to ack message id =&gt;&#123;&#125;"</span>, messageId);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            log.info(<span class="string">"consumer done &#123;&#125;"</span>, sdf.format(<span class="keyword">new</span> Date()));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这时就可以重现”数据丢失”的问题了!</p>
<p><img src="/img/rabbit-channel-0.png" alt="img"><br><img src="/img/rabbit-channel-1.png" alt="img"></p>
<ul>
<li>可以看到, 它复用了 channel (它们的内存地址同样为 6d7d893)</li>
<li><p>第二轮时, 它的 delivery id 是从 201 开始的! (实际上, 我们期待它应该是从 1 开始的或 消息内容从 hello101 开始! 因为我们只 ack 了前100条, 那后续的处理应该接着上一轮继续处理的)</p>
</li>
<li><p>那为什么 template 处理完后 执行了 <code>channel.close()</code> 并没有真实关闭呢(因为缓存 channel, close 的时候, 只是放回缓存池)</p>
</li>
</ul>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>强制刷新 channel (即让 mq 每次都创建一个新的 channel, 虽然缓存模式为 channel, 但这种情况下, 看来只能强制关闭 channel, 让还没有真正处理的消息返回队列, 然后重新出队 ack了. 不知道还有没有更好的方式, 有的话, 请 email 我哈)</p>
<p>即在代码最后 <code>return null;</code> 之前, 添加以下方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">channel.abort()</div></pre></td></tr></table></figure>
<p>这个方法, 会强制关闭 channel , 由于 consumer 设置了手动 ack, 所以那些未被插入DB的内存消息会重新出队.</p>
<p>这时, 可以看到 </p>
<p><img src="/img/rabbit-channel-2.png" alt="img"><br><img src="/img/rabbit-channel-3.png" alt="img"></p>
<ul>
<li>channel 每次都是新的了</li>
<li>消息是接着上一轮开始的, 并且没有 “丢失” </li>
</ul>

                                
    </div>
</article>

   
  <div class="text-center donation">
    <div class="inner-donation">
      <span class="btn-donation">支持一下</span>
      <div class="donation-body">
        <div class="tip text-center">扫一扫，支持 emacsist</div>
        <ul class="theme.donation.items.length">
        
          <li class="item">
            <img src="/img/wxpay.jpeg" alt="">
          </li>
        
          <li class="item">
            <img src="/img/alipay.jpeg" alt="">
          </li>
        
        </ul>
      </div>
    </div>
  </div>


   



</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tags/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/books/"
              rel="noopener noreferrer"
              target="_self"
              >
              阅读
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    




    

    
	
  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
